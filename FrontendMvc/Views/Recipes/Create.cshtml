@model FrontendMvc.Models.Recipes.RecipeViewModel

@{
    ViewData["Title"] = "Yeni Tarif Ekle";
    var categories = ViewBag.Categories as List<FrontendMvc.Models.Recipes.CategoryViewModel> ?? new();
}

@section Styles {
    <link rel="stylesheet" href="~/css/recipe-form.css" />
}

<div class="recipe-create-container">
    <div class="row">
        <div class="col-12">
            <div class="bd bgc-white p-20 recipe-create-container">
                <div class="layers">
                    <div class="layer w-100 mB-15">
                        <div class="peers fxw-nw ai-c">
                            <div class="peer peer-greed">
                                <h4 class="lh-1 mB-0">
                                    <i class="ti-plus mR-10"></i> Yeni Tarif Ekle
                                </h4>
                            </div>
                        </div>
                    </div>

                    <div class="layer w-100 mB-15">
                        <form asp-action="Create" method="post" enctype="multipart/form-data">
                            <!-- HÄ±zlÄ± Bilgi Ã‡ubuÄŸu -->
                            <div class="layer w-100 mB-5">
                                <div class="quick-info-bar">
                                    <div class="quick-info-item">
                                        <div class="form-check">
                                            <input asp-for="IsFeatured" class="form-check-input" type="checkbox" id="IsFeaturedTop" />
                                            <label class="form-check-label" for="IsFeaturedTop">
                                                <i class="ti-star mR-5"></i> Ã–ne Ã‡Ä±kan
                                            </label>
                                        </div>
                                    </div>
                                    <div class="quick-info-item">
                                        <label asp-for="PrepTimeMinutes" class="mB-0">
                                            <i class="ti-timer mR-5"></i> HazÄ±rlÄ±k (dk):
                                        </label>
                                        <input asp-for="PrepTimeMinutes" class="form-control form-control-sm d-inline-block" type="number" min="0" placeholder="0" />
                                    </div>
                                    <div class="quick-info-item">
                                        <label asp-for="CookingTimeMinutes" class="mB-0">
                                            <i class="ti-time mR-5"></i> PiÅŸirme (dk) *:
                                        </label>
                                        <input asp-for="CookingTimeMinutes" class="form-control form-control-sm d-inline-block" type="number" min="1" required placeholder="30" />
                                        <span asp-validation-for="CookingTimeMinutes" class="text-danger fsz-xs"></span>
                                    </div>
                                    <div class="quick-info-item">
                                        <label asp-for="Servings" class="mB-0">
                                            <i class="ti-user mR-5"></i> KaÃ§ KiÅŸilik:
                                        </label>
                                        <input asp-for="Servings" class="form-control form-control-sm d-inline-block" type="number" min="1" placeholder="4" style="width: 60px; min-width: 60px; max-width: 60px; text-align: center;" />
                                    </div>
                                    <div class="quick-info-item">
                                        <label asp-for="Difficulty" class="mB-0">
                                            <i class="ti-settings mR-5"></i> Zorluk:
                                        </label>
                                        <select asp-for="Difficulty" class="form-control form-control-sm d-inline-block">
                                            <option value="Kolay">ðŸŸ¢ Kolay</option>
                                            <option value="Orta" selected>ðŸŸ¡ Orta</option>
                                            <option value="Zor">ðŸ”´ Zor</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <!-- Sol Kolon -->
                                <div class="col-lg-6 col-md-6">
                                    <div class="layers">
                                        <div class="layer w-100 mB-15">
                                            <label asp-for="Title" class="form-label fw-600">
                                                <i class="ti-bookmark mR-5"></i> Tarif AdÄ± *
                                            </label>
                                            <input asp-for="Title" class="form-control" required placeholder="Ã–rn: Tavuklu Pilav" />
                                            <span asp-validation-for="Title" class="text-danger fsz-sm"></span>
                                        </div>

                                        <div class="layer w-100 mB-15">
                                            <label asp-for="Ingredients" class="form-label fw-600">
                                                <i class="ti-shopping-cart mR-5"></i> Malzemeler *
                                            </label>
                                            <div style="margin-top:22px;"></div>
                                            <div id="ingredientsEditor"></div>
                                            <textarea asp-for="Ingredients" id="Ingredients" name="Ingredients" class="d-none" required></textarea>
                                            <span asp-validation-for="Ingredients" class="text-danger fsz-sm"></span>
                                        </div>

                                        <div class="layer w-100 mB-20">
                                            <label asp-for="Description" class="form-label fw-600">
                                                <i class="ti-file-text mR-5"></i> KÄ±sa AÃ§Ä±klama
                                            </label>
                                            <textarea asp-for="Description" class="form-control" rows="2" placeholder="Tarif hakkÄ±nda kÄ±sa bir aÃ§Ä±klama yazÄ±n"></textarea>
                                            <span asp-validation-for="Description" class="text-danger fsz-sm"></span>
                                        </div>

                                        <div class="layer w-100 mB-15">
                                            <label asp-for="Tips" class="form-label fw-600">
                                                <i class="ti-light-bulb mR-5"></i> PÃ¼f NoktalarÄ±
                                            </label>
                                            <textarea asp-for="Tips" class="form-control" rows="3"
                                                      placeholder="PÃ¼f noktalarÄ±"></textarea>
                                        </div>

                                    </div>
                                </div>

                                <!-- SaÄŸ Kolon -->
                                <div class="col-lg-6 col-md-6">
                                    <div class="layers">
                                        <div class="layer w-100 mB-15">
                                            <label asp-for="CategoryId" class="form-label fw-600">
                                                <i class="ti-folder mR-5"></i> Kategori
                                            </label>
                                            <select asp-for="CategoryId" class="form-control">
                                                <option value="">Kategori SeÃ§in</option>
                                                @foreach (var category in categories)
                                                {
                                                    <option value="@category.Id">@category.Name</option>
                                                }
                                            </select>
                                        </div>

                                        <div class="layer w-100 mB-15">
                                            <div class="d-flex justify-content-between align-items-center mB-10">
                                                <label class="form-label fw-600 mB-0">
                                                    <i class="ti-list mR-5"></i> YapÄ±lÄ±ÅŸ *
                                                </label>
                                                <button type="button" class="dynamic-list-add-btn" onclick="addStepItem()">
                                                    <i class="ti-plus"></i> AdÄ±m Ekle
                                                </button>
                                            </div>
                                            <div id="stepsList" class="dynamic-list"></div>
                                            <textarea asp-for="Steps" id="Steps" name="Steps" class="d-none" required></textarea>
                                            <span asp-validation-for="Steps" class="text-danger fsz-sm"></span>
                                        </div>

                                        <div class="layer w-100 mB-15">
                                            <label class="form-label fw-600 mB-8">
                                                <i class="ti-image mR-5"></i> Tarif GÃ¶rselleri
                                            </label>
                                            <small class="c-grey-600 d-block mB-10">Birden Ã§ok fotoÄŸraf ekleyebilirsiniz. Birini ana fotoÄŸraf olarak seÃ§ebilirsiniz.</small>
                                            
                                            <!-- Ã‡oklu dosya yÃ¼kleme -->
                                            <div class="mB-10">
                                                <input type="file" name="imageFiles" id="imageFiles" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" class="form-control" multiple />
                                                <small class="c-grey-600 d-block mT-5">JPG, PNG, GIF veya WebP formatÄ±nda, maksimum 5MB (birden Ã§ok seÃ§ebilirsiniz)</small>
                                            </div>
                                            
                                            <!-- URL ile ekleme -->
                                            <div class="mB-10">
                                                <div class="d-flex gap-10 ai-c" style="flex-wrap: wrap;">
                                                    <input type="text" id="imageUrlInput" class="form-control" placeholder="https://example.com/image.jpg" style="flex: 1; min-width: 200px;" />
                                                    <button type="button" id="addImageUrl" class="btn btn-sm btn-outline-primary">
                                                        <i class="ti-plus"></i> URL Ekle
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- YÃ¼klenen gÃ¶rseller listesi -->
                                            <div id="imagesList" class="mT-15">
                                                <!-- GÃ¶rseller buraya eklenecek -->
                                            </div>
                                            
                                            <!-- Hidden input for image URLs -->
                                            <input type="hidden" id="imageUrlsJson" name="imageUrlsJson" />
                                            <input type="hidden" id="primaryImageIndex" name="primaryImageIndex" value="0" />
                                        </div>
                                        <div class="layer w-100 mB-15">
                                            <label asp-for="AlternativeIngredients" class="form-label fw-600">
                                                <i class="ti-exchange-vertical mR-5"></i> Alternatif Malzemeler
                                            </label>
                                            <textarea asp-for="AlternativeIngredients" class="form-control" rows="3"
                                                      placeholder="Alternatif malzemeler"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                                <div class="row mT-20">
                                    <div class="bd-top pT-15">
                                        <div class="peers fxw-nw gap-10" style="justify-content: flex-end;">
                                            <div class="peer">
                                                <button type="submit" class="btn btn-primary" style="color: white;">
                                                    <i class="ti-save mR-5"></i> Kaydet
                                                </button>
                                            </div>
                                            <div class="peer">
                                                <a asp-controller="Recipes" asp-action="Index" class="btn btn-secondary" style="color: white;">
                                                    <i class="ti-close mR-5"></i> Ä°ptal
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @section Scripts {
        <partial name="_ValidationScriptsPartial" />
        <script src="~/js/recipe-form.js"></script>
        <script>
            // Ã‡oklu fotoÄŸraf yÃ¶netimi
            let uploadedImages = [];
            let primaryImageIndex = 0;

            const imageFilesInput = document.getElementById('imageFiles');
            const imageUrlInput = document.getElementById('imageUrlInput');
            const addImageUrlBtn = document.getElementById('addImageUrl');
            const imagesList = document.getElementById('imagesList');
            const imageUrlsJsonInput = document.getElementById('imageUrlsJson');
            const primaryImageIndexInput = document.getElementById('primaryImageIndex');

            // Dosya seÃ§ildiÄŸinde
            if (imageFilesInput) {
                imageFilesInput.addEventListener('change', function(e) {
                    const files = Array.from(e.target.files);
                    files.forEach(file => {
                        if (file.size > 5 * 1024 * 1024) {
                            alert(`${file.name} dosyasÄ± 5MB'dan bÃ¼yÃ¼k!`);
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const imageData = {
                                url: e.target.result,
                                file: file,
                                isFile: true,
                                isPrimary: uploadedImages.length === 0
                            };
                            uploadedImages.push(imageData);
                            if (uploadedImages.length === 1) {
                                primaryImageIndex = 0;
                                primaryImageIndexInput.value = '0';
                            }
                            renderImagesList();
                        };
                        reader.readAsDataURL(file);
                    });
                });
            }

            // URL ile ekleme
            if (addImageUrlBtn && imageUrlInput) {
                addImageUrlBtn.addEventListener('click', function() {
                    const url = imageUrlInput.value.trim();
                    if (!url) {
                        alert('LÃ¼tfen geÃ§erli bir URL giriniz!');
                        return;
                    }
                    const imageData = {
                        url: url,
                        isFile: false,
                        isPrimary: uploadedImages.length === 0
                    };
                    uploadedImages.push(imageData);
                    if (uploadedImages.length === 1) {
                        primaryImageIndex = 0;
                        primaryImageIndexInput.value = '0';
                    }
                    imageUrlInput.value = '';
                    renderImagesList();
                });
            }

            // GÃ¶rselleri render et
            function renderImagesList() {
                if (!imagesList) return;
                
                imagesList.innerHTML = '';
                
                uploadedImages.forEach((img, index) => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-item mB-10 p-10 bd bgc-grey-50';
                    imageItem.style.cssText = 'display: flex; align-items: center; gap: 15px; border-radius: 8px;';
                    
                    imageItem.innerHTML = `
                        <div style="position: relative; width: 100px; height: 100px; flex-shrink: 0;">
                            <img src="${img.url}" alt="GÃ¶rsel ${index + 1}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;" />
                            ${img.isPrimary ? '<span class="badge bg-primary" style="position: absolute; top: 5px; left: 5px;">Ana FotoÄŸraf</span>' : ''}
                        </div>
                        <div style="flex: 1;">
                            <div class="fw-600 mB-5">GÃ¶rsel ${index + 1}</div>
                            <div class="fsz-sm text-muted mB-10">${img.isFile ? 'YÃ¼klenecek dosya' : 'URL'}</div>
                            <div class="d-flex gap-10">
                                <button type="button" class="btn btn-sm ${img.isPrimary ? 'btn-primary' : 'btn-outline-primary'}" onclick="setPrimaryImage(${index})">
                                    <i class="ti-star"></i> ${img.isPrimary ? 'Ana FotoÄŸraf' : 'Ana FotoÄŸraf Yap'}
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeImage(${index})">
                                    <i class="ti-close"></i> KaldÄ±r
                                </button>
                            </div>
                        </div>
                    `;
                    
                    imagesList.appendChild(imageItem);
                });
                
                // Hidden input'u gÃ¼ncelle
                if (imageUrlsJsonInput) {
                    const urls = uploadedImages.map(img => img.url);
                    imageUrlsJsonInput.value = JSON.stringify(urls);
                }
            }

            // Ana fotoÄŸraf seÃ§
            window.setPrimaryImage = function(index) {
                uploadedImages.forEach((img, i) => {
                    img.isPrimary = i === index;
                });
                primaryImageIndex = index;
                primaryImageIndexInput.value = index.toString();
                renderImagesList();
            };

            // GÃ¶rseli kaldÄ±r
            window.removeImage = function(index) {
                if (confirm('Bu gÃ¶rseli kaldÄ±rmak istediÄŸinize emin misiniz?')) {
                    uploadedImages.splice(index, 1);
                    if (uploadedImages.length > 0) {
                        if (primaryImageIndex >= uploadedImages.length) {
                            primaryImageIndex = 0;
                        }
                        uploadedImages[primaryImageIndex].isPrimary = true;
                        primaryImageIndexInput.value = primaryImageIndex.toString();
                    } else {
                        primaryImageIndex = 0;
                        primaryImageIndexInput.value = '0';
                    }
                    renderImagesList();
                }
            };

            // Form submit edilmeden Ã¶nce gÃ¶rselleri S3'e yÃ¼kle
            const form = document.querySelector('form');
            if (form) {
                const submitHandler = async function(e) {
                    console.log('Form submit event tetiklendi');
                    e.preventDefault(); // Ã–nce S3'e yÃ¼kleyelim
                    
                    // Form validation kontrolÃ¼
                    if (!form.checkValidity()) {
                        console.error('Form validation hatasÄ± var');
                        form.reportValidity();
                        return;
                    }
                    
                    // Ã–NEMLÄ°: Form submit edilmeden Ã¶nce Ingredients ve Steps textarea'larÄ±nÄ± gÃ¼ncelle
                    // Quill editÃ¶rÃ¼nden iÃ§eriÄŸi al
                    if (typeof ingredientsQuill !== 'undefined' && ingredientsQuill) {
                        const ingredientsTextarea = document.getElementById('Ingredients');
                        if (ingredientsTextarea) {
                            const htmlData = ingredientsQuill.root.innerHTML;
                            if (typeof convertHtmlToPlainText === 'function') {
                                const plain = convertHtmlToPlainText(htmlData);
                                ingredientsTextarea.value = plain;
                                console.log('Ingredients gÃ¼ncellendi:', plain.substring(0, 50) + '...');
                            } else {
                                // Fallback: HTML'den text Ã§Ä±kar
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = htmlData;
                                ingredientsTextarea.value = tempDiv.textContent || tempDiv.innerText || '';
                                console.log('Ingredients gÃ¼ncellendi (fallback)');
                            }
                        } else {
                            console.error('Ingredients textarea bulunamadÄ±!');
                        }
                    } else {
                        console.warn('ingredientsQuill tanÄ±mlÄ± deÄŸil');
                    }
                    
                    // Steps textarea'sÄ±nÄ± gÃ¼ncelle
                    if (typeof updateStepsTextarea === 'function') {
                        updateStepsTextarea();
                        const stepsTextarea = document.getElementById('Steps');
                        if (stepsTextarea) {
                            console.log('Steps gÃ¼ncellendi:', stepsTextarea.value.substring(0, 50) + '...');
                        }
                    } else {
                        // Fallback: Manuel olarak gÃ¼ncelle
                        const stepsList = document.getElementById('stepsList');
                        const stepsTextarea = document.getElementById('Steps');
                        if (stepsList && stepsTextarea) {
                            const items = stepsList.querySelectorAll('.item-input');
                            const values = Array.from(items).map(input => input.value.trim()).filter(v => v);
                            stepsTextarea.value = values.join('\n');
                            console.log('Steps gÃ¼ncellendi (fallback):', stepsTextarea.value.substring(0, 50) + '...');
                        } else {
                            console.error('Steps textarea veya list bulunamadÄ±!');
                        }
                    }
                    
                    // Dosya yÃ¼kleme iÃ§in Ã¶nce S3'e yÃ¼kle
                    const filesToUpload = [];
                    uploadedImages.forEach(img => {
                        if (img.isFile && img.file) {
                            filesToUpload.push(img);
                        }
                    });
                    
                    console.log('YÃ¼klenecek dosya sayÄ±sÄ±:', filesToUpload.length);
                    
                    // DosyalarÄ± S3'e yÃ¼kle
                    if (filesToUpload.length > 0) {
                        console.log('Dosyalar S3\'e yÃ¼kleniyor...');
                        const uploadPromises = filesToUpload.map(async (imgData, index) => {
                            try {
                                const formData = new FormData();
                                formData.append('file', imgData.file);
                                
                                // Token'Ä± al
                                let token = '';
                                if (typeof getAuthToken === 'function') {
                                    token = getAuthToken();
                                } else if (typeof localStorage !== 'undefined') {
                                    token = localStorage.getItem('authToken') || '';
                                }
                                
                                const headers = {};
                                if (token) {
                                    headers['Authorization'] = `Bearer ${token}`;
                                }
                                
                                // Backend API URL'ini al
                                const apiBaseUrl = window.API_BASE_URL || 'https://localhost:7016';
                                const uploadUrl = `${apiBaseUrl}/api/upload/image`;
                                
                                const response = await fetch(uploadUrl, {
                                    method: 'POST',
                                    headers: headers,
                                    body: formData
                                });
                                
                                if (response.ok) {
                                    const result = await response.json();
                                    if (result.url) {
                                        // Base64 URL'yi S3 URL'i ile deÄŸiÅŸtir
                                        const oldIndex = uploadedImages.findIndex(img => img === imgData);
                                        if (oldIndex !== -1) {
                                            uploadedImages[oldIndex].url = result.url;
                                            uploadedImages[oldIndex].isFile = false; // ArtÄ±k URL
                                        }
                                        return result.url;
                                    }
                                } else {
                                    const error = await response.text();
                                    console.error('S3 upload failed:', error);
                                    throw new Error(`Upload failed: ${error}`);
                                }
                            } catch (error) {
                                console.error('Error uploading to S3:', error);
                                throw error;
                            }
                        });
                        
                        try {
                            await Promise.all(uploadPromises);
                            console.log('TÃ¼m dosyalar S3\'e yÃ¼klendi');
                            // TÃ¼m dosyalar yÃ¼klendi, ÅŸimdi formu submit et
                            renderImagesList();
                            
                            // imageFiles input'unu temizle (artÄ±k S3'e yÃ¼klendi, backend'e gÃ¶ndermeye gerek yok)
                            if (imageFilesInput) {
                                imageFilesInput.value = '';
                            }
                            
                            // imageUrlsJson ve primaryImageIndex'i gÃ¼ncelle
                            if (imageUrlsJsonInput) {
                                const urls = uploadedImages.map(img => img.url);
                                imageUrlsJsonInput.value = JSON.stringify(urls);
                                console.log('Image URLs gÃ¼ncellendi:', urls.length, 'gÃ¶rsel');
                            }
                            
                            // Form submit etmeden Ã¶nce bir saniye bekle (UI gÃ¼ncellemesi iÃ§in)
                            console.log('Form submit ediliyor (dosyalar yÃ¼klendikten sonra)...');
                            setTimeout(() => {
                                // Event listener'Ä± kaldÄ±r (sonsuz dÃ¶ngÃ¼yÃ¼ Ã¶nlemek iÃ§in)
                                form.removeEventListener('submit', submitHandler);
                                // Programatik submit - event listener'lar Ã§alÄ±ÅŸmaz
                                form.submit();
                            }, 500);
                        } catch (error) {
                            alert('FotoÄŸraflar yÃ¼klenirken hata oluÅŸtu: ' + error.message);
                            console.error('Upload error:', error);
                            // Hata olsa bile formu submit et (kullanÄ±cÄ± tekrar deneyebilir)
                            // form.submit();
                        }
                    } else {
                        // YÃ¼klenecek dosya yok, direkt submit et
                        console.log('YÃ¼klenecek dosya yok, form direkt submit ediliyor...');
                        
                        // imageUrlsJson ve primaryImageIndex'i gÃ¼ncelle
                        if (imageUrlsJsonInput && uploadedImages.length > 0) {
                            const urls = uploadedImages.map(img => img.url);
                            imageUrlsJsonInput.value = JSON.stringify(urls);
                            console.log('Image URLs gÃ¼ncellendi:', urls.length, 'gÃ¶rsel');
                        }
                        
                        // Event listener'Ä± kaldÄ±r (sonsuz dÃ¶ngÃ¼yÃ¼ Ã¶nlemek iÃ§in)
                        form.removeEventListener('submit', submitHandler);
                        // Programatik submit - event listener'lar Ã§alÄ±ÅŸmaz
                        form.submit();
                    }
                };
                form.addEventListener('submit', submitHandler);
            }
        </script>
    }
</div>
