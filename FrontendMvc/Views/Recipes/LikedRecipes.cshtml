@model IEnumerable<FrontendMvc.Models.Recipes.RecipeViewModel>

@{
    ViewData["Title"] = "Beğendiğim Tarifler";
    var categories = ViewBag.Categories as List<FrontendMvc.Models.Recipes.CategoryViewModel> ?? new();
    var searchTerm = ViewBag.SearchTerm as string;
    var hasSearch = !string.IsNullOrWhiteSpace(searchTerm);
}

<div class="row gap-20">
    <div class="col-12">
        <div class="bd bgc-white p-20">
            <div class="layers">
                <div class="layer w-100 mB-20">
                    <div class="peers fxw-nw ai-c">
                        <div class="peer peer-greed">
                            <h4 class="lh-1 mB-0">
                                <i class="ti-heart c-red-500 mR-10"></i>
                                Beğendiğim Tarifler
                            </h4>
                        </div>
                    </div>
                </div>
                
                <!-- Arama Formu -->
                <div class="layer w-100 mB-20">
                    <form asp-controller="Recipes" asp-action="LikedRecipes" method="get" id="searchForm">
                        <div class="d-flex" style="gap: 8px;">
                            <div class="search-input-wrapper" style="flex: 1; position: relative;">
                                <i class="ti-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; font-size: 18px; pointer-events: none;"></i>
                                <input type="text" name="search" id="searchInput" class="form-control" placeholder="Beğendiğiniz tariflerde ara..." value="@searchTerm" style="padding-left: 45px;">
                            </div>
                            <button type="submit" class="btn btn-primary" style="color: white; white-space: nowrap; padding: 8px 20px;">
                                <i class="ti-search mR-5"></i> Ara
                            </button>
                            @if (hasSearch)
                            {
                                <a asp-controller="Recipes" asp-action="LikedRecipes" class="btn btn-outline-secondary" style="white-space: nowrap; padding: 8px 20px;">
                                    <i class="ti-close mR-5"></i> Temizle
                                </a>
                            }
                        </div>
                    </form>
                </div>
                
                @if (hasSearch)
                {
                    <div class="layer w-100 mB-15">
                        <div class="bd bgc-grey-100 p-8 bdrs-3" style="display: inline-flex; align-items: center; gap: 8px;">
                            <span class="fw-600" style="font-size: 12px; color: #666;">Arama:</span>
                            <span style="font-size: 14px;">"@searchTerm"</span>
                            <a asp-controller="Recipes" asp-action="LikedRecipes" class="c-grey-600 cH-red td-n" style="margin-left: 5px;">
                                <i class="ti-close" style="font-size: 14px;"></i>
                            </a>
                        </div>
                    </div>
                }
                
                @if (Model == null || !Model.Any())
                {
                    <div class="layer w-100">
                        <div class="ta-c p-40">
                            @if (hasSearch)
                            {
                                <i class="ti-search fsz-xxl c-grey-400 mB-20"></i>
                                <h5 class="c-grey-600 mB-10">Arama sonucu bulunamadı</h5>
                                <p class="c-grey-500 mB-20">"@searchTerm" için beğendiğiniz tarifler arasında sonuç bulunamadı.</p>
                                <a asp-controller="Recipes" asp-action="LikedRecipes" class="btn btn-primary" style="color: white;">
                                    <i class="ti-arrow-left mR-5"></i> Tüm Beğenilen Tarifler
                                </a>
                            }
                            else
                            {
                                <i class="ti-heart-broken fsz-xxl c-grey-400 mB-20"></i>
                                <h5 class="c-grey-600 mB-10">Henüz beğendiğiniz tarif yok</h5>
                                <p class="c-grey-500 mB-20">Beğenmek istediğiniz tariflerin kalp ikonuna tıklayabilirsiniz.</p>
                                <a asp-controller="Home" asp-action="Index" class="btn btn-primary" style="color: white;">
                                    <i class="ti-arrow-left mR-5"></i> Ana Sayfaya Dön
                                </a>
                            }
                        </div>
                    </div>
                }
                else
                {
                    <div class="layer w-100">
                        <p class="c-grey-600 mB-20">
                            @if (hasSearch)
                            {
                                <text>"@searchTerm" için @Model.Count() sonuç bulundu.</text>
                            }
                            else
                            {
                                <text>@Model.Count() tarif beğenmişsiniz.</text>
                            }
                        </p>
                    </div>
                    
                    <div class="row gap-20 justify-content-center" id="recipesContainer">
                        @foreach (var recipe in Model)
                        {
                            <div class="col-md-6 col-lg-3 mb-3 recipe-item">
                                <a asp-controller="Recipes" asp-action="Details" asp-route-id="@recipe.Id" class="recipe-card-link" style="text-decoration: none; display: block; height: 100%;">
                                    <div class="bd bgc-white bdrs-3 ov-h recipe-card" style="transition: all 0.3s ease; cursor: pointer; display: flex; flex-direction: column; height: 100%;">
                                        @if (!string.IsNullOrEmpty(recipe.ImageUrl))
                                        {
                                            <div class="recipe-card-image-wrapper" style="position: relative; overflow: hidden;">
                                                <img src="@recipe.ImageUrl" alt="@recipe.Title" class="w-100" style="height: 200px; object-fit: cover; transition: transform 0.3s ease;" loading="lazy" decoding="async">
                                                <div class="recipe-card-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to top, rgba(0,0,0,0.6), transparent); opacity: 0; transition: opacity 0.3s ease; display: flex; align-items: flex-end; padding: 15px;">
                                                    <span class="c-white fw-600" style="font-size: 14px;">
                                                        <i class="ti-eye mR-5"></i> Detayları Gör
                                                    </span>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="w-100 bgc-grey-200" style="height: 200px; display: flex; align-items: center; justify-content: center; position: relative;">
                                                <i class="ti-image fsz-xxl c-grey-400"></i>
                                                <div class="recipe-card-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s ease; display: flex; align-items: center; justify-content: center;">
                                                    <span class="c-white fw-600">
                                                        <i class="ti-eye mR-5"></i> Detayları Gör
                                                    </span>
                                                </div>
                                            </div>
                                        }
                                        <div class="p-20" style="flex: 1; display: flex; flex-direction: column;">
                                            <h6 class="mB-10 c-grey-800" style="transition: color 0.3s ease; min-height: 48px; line-height: 1.4;">
                                                @recipe.Title
                                            </h6>
                                            <p class="fsz-sm c-grey-600 mB-10" style="min-height: 40px; line-height: 1.4;">
                                                @(recipe.Description.Length > 100 ? recipe.Description.Substring(0, 100) + "..." : recipe.Description)
                                            </p>
                                            <div class="peers fxw-nw ai-c fsz-sm c-grey-600 mB-10" style="min-height: 24px; flex-shrink: 0;">
                                                <div class="peer mR-15">
                                                    <i class="ti-time"></i> @recipe.CookingTimeMinutes dk
                                                </div>
                                                <div class="peer mR-15">
                                                    <i class="ti-user"></i> @recipe.Servings kişilik
                                                </div>
                                                @if (recipe.Category != null)
                                                {
                                                    <div class="peer">
                                                        <i class="@recipe.Category.Icon"></i> @recipe.Category.Name
                                                    </div>
                                                }
                                            </div>
                                            <div class="peers fxw-nw ai-c mT-10 gap-10" style="min-height: 32px; flex-shrink: 0; margin-top: auto; align-items: center;">
                                                <div class="peer" style="min-width: 120px;">
                                                    @if (recipe.AverageRating.HasValue)
                                                    {
                                                        <div class="peers fxw-nw ai-c">
                                                            <div class="peer" style="display: inline-flex; align-items: center; gap: 2px;">
                                                                @{
                                                                    double visualRating = recipe.AverageRating.Value * 2; // 1-5 -> 2-10
                                                                }
                                                                @for (int i = 0; i < 5; i++)
                                                                {
                                                                    int starValue = (i + 1) * 2; // 2, 4, 6, 8, 10
                                                                    int starStart = i * 2; // 0, 2, 4, 6, 8
                                                                    
                                                                    if (visualRating >= starValue)
                                                                    {
                                                                        <i class="ti-star c-yellow-500" style="font-size: 14px;"></i>
                                                                    }
                                                                    else if (visualRating > starStart && visualRating < starValue)
                                                                    {
                                                                        double fractionalPart = (visualRating - starStart) / (starValue - starStart);
                                                                        double fillPercentage = fractionalPart * 100;
                                                                        <div style="position: relative; display: inline-block; width: 14px; height: 14px; line-height: 1;">
                                                                            <i class="ti-star c-grey-300" style="font-size: 14px; position: absolute; left: 0; top: 0; z-index: 1;"></i>
                                                                            <div style="position: absolute; left: 0; top: 0; width: @(fillPercentage.ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%; height: 14px; overflow: hidden; z-index: 2;">
                                                                                <i class="ti-star c-yellow-500" style="font-size: 14px; position: absolute; left: 0; top: 0; width: 14px; height: 14px; display: block;"></i>
                                                                            </div>
                                                                        </div>
                                                                    }
                                                                    else
                                                                    {
                                                                        <i class="ti-star c-grey-300" style="font-size: 14px;"></i>
                                                                    }
                                                                }
                                                            </div>
                                                            <div class="peer mL-5 fsz-sm c-grey-600">
                                                                <span class="fw-600">@recipe.AverageRating.Value.ToString("F1")</span> (@recipe.RatingCount)
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                                <div class="peer" style="min-width: 50px;">
                                                    @if (recipe.LikeCount > 0)
                                                    {
                                                        <i class="ti-heart c-red-500"></i>
                                                        <span class="fsz-sm c-grey-600 mL-3">@recipe.LikeCount</span>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    /* Recipe Card Hover Effects */
    .recipe-card-link {
        text-decoration: none !important;
    }
    
    .recipe-card {
        transition: all 0.3s ease;
    }
    
    .recipe-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.15) !important;
    }
    
    .recipe-card:hover .recipe-card-image-wrapper img {
        transform: scale(1.05);
    }
    
    .recipe-card:hover .recipe-card-overlay {
        opacity: 1 !important;
    }
    
    .recipe-card:hover h6 {
        color: #007bff !important;
    }
    
    /* 2 veya 3 kayıt olduğunda daha güzel görünüm */
    #recipesContainer {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
    }
    
    .recipe-item {
        flex: 0 0 auto;
        min-width: 280px;
        max-width: 100%;
    }
    
    /* 2 kayıt varsa her biri daha geniş olsun */
    @@media (min-width: 992px) {
        #recipesContainer.recipe-count-2 .recipe-item {
            flex: 0 0 calc(50% - 10px);
            max-width: calc(50% - 10px);
        }
        
        #recipesContainer.recipe-count-3 .recipe-item {
            flex: 0 0 calc(33.333% - 14px);
            max-width: calc(33.333% - 14px);
        }
        
        #recipesContainer.recipe-count-1 .recipe-item {
            flex: 0 0 calc(50% - 10px);
            max-width: calc(50% - 10px);
            margin: 0 auto;
        }
    }
    
    /* Küçük ekranlarda da düzgün görünsün */
    @@media (max-width: 991px) {
        .recipe-item {
            flex: 0 0 100%;
            max-width: 100%;
        }
    }
    
    @@media (min-width: 768px) and (max-width: 991px) {
        .recipe-item {
            flex: 0 0 calc(50% - 10px);
            max-width: calc(50% - 10px);
        }
    }
</style>

@section Scripts {
    <script>
        // Submit form on Enter key
        const searchInput = document.getElementById('searchInput');
        const searchForm = document.getElementById('searchForm');
        if (searchInput && searchForm) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchForm.submit();
                }
            });
        }
        
        // Kayıt sayısına göre container'a class ekle
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('recipesContainer');
            if (container) {
                const recipeCount = container.querySelectorAll('.recipe-item').length;
                if (recipeCount > 0 && recipeCount < 4) {
                    container.classList.add('recipe-count-' + recipeCount);
                }
            }
        });
    </script>
}
