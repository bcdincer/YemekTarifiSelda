@model FrontendMvc.Models.Recipes.RecipeViewModel

@{
    ViewData["Title"] = "Tarif DÃ¼zenle";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var categories = ViewBag.Categories as List<FrontendMvc.Models.Recipes.CategoryViewModel> ?? new();
}

@section Styles {
    <link rel="stylesheet" href="~/css/recipe-form.css" />
}

<div class="edit-recipe-container">
    <div class="row">
        <div class="col-12">
            <div class="bd bgc-white p-20 edit-recipe-container">
                <div class="layers">
                    <div class="layer w-100 mB-15">
                        <div class="peers fxw-nw ai-c"> 
                            <div class="peer peer-greed">
                                <h4 class="lh-1 mB-0">
                                    <i class="ti-pencil mR-10"></i> Tarif DÃ¼zenle
                                </h4>
                            </div>
                            <div class="peer">
                                <a asp-controller="Author" asp-action="MyRecipes" class="btn btn-outline-secondary">
                                    <i class="ti-arrow-left mR-5"></i> Geri DÃ¶n
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="layer w-100 mB-15">
                        <form asp-action="Edit" asp-controller="Recipes" asp-route-id="@Model.Id" method="post" enctype="multipart/form-data" id="editRecipeForm">
                            @Html.AntiForgeryToken()
                            <input type="hidden" asp-for="Id" />

                            <!-- HÄ±zlÄ± Bilgi Ã‡ubuÄŸu -->
                            <div class="layer w-100 mB-5">
                                <div class="quick-info-bar">
                                    <div class="quick-info-item">
                                        <div class="form-check">
                                            <input asp-for="IsFeatured" class="form-check-input" type="checkbox" id="IsFeaturedTop" />
                                            <label class="form-check-label" for="IsFeaturedTop">
                                                <i class="ti-star mR-5"></i> Ã–ne Ã‡Ä±kan
                                            </label>
                                        </div>
                                    </div>
                                    <div class="quick-info-item">
                                        <label asp-for="PrepTimeMinutes" class="mB-0">
                                            <i class="ti-timer mR-5"></i> HazÄ±rlÄ±k (dk):
                                        </label>
                                        <input asp-for="PrepTimeMinutes" class="form-control form-control-sm d-inline-block" type="number" min="0" placeholder="0" />
                                    </div>
                                    <div class="quick-info-item">
                                        <label asp-for="CookingTimeMinutes" class="mB-0">
                                            <i class="ti-time mR-5"></i> PiÅŸirme (dk) *:
                                        </label>
                                        <input asp-for="CookingTimeMinutes" class="form-control form-control-sm d-inline-block" type="number" min="1" required placeholder="30" />
                                        <span asp-validation-for="CookingTimeMinutes" class="text-danger fsz-xs"></span>
                                    </div>
                                    <div class="quick-info-item">
                                        <label asp-for="Servings" class="mB-0">
                                            <i class="ti-user mR-5"></i> KaÃ§ KiÅŸilik:
                                        </label>
                                        <input asp-for="Servings" class="form-control form-control-sm d-inline-block servings-input" type="number" min="1" placeholder="4" />
                                    </div>
                                    <div class="quick-info-item">
                                        <label asp-for="Difficulty" class="mB-0">
                                            <i class="ti-settings mR-5"></i> Zorluk:
                                        </label>
                                        <select asp-for="Difficulty" class="form-control form-control-sm d-inline-block">
                                            <option value="Kolay" selected="@(Model.Difficulty == "Kolay")">ðŸŸ¢ Kolay</option>
                                            <option value="Orta" selected="@(Model.Difficulty == "Orta")">ðŸŸ¡ Orta</option>
                                            <option value="Zor" selected="@(Model.Difficulty == "Zor")">ðŸ”´ Zor</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <!-- Sol Kolon -->
                                <div class="col-lg-6 col-md-6">
                                    <div class="layers">
                                        <div class="layer w-100 mB-15">
                                            <label asp-for="Title" class="form-label fw-600">
                                                <i class="ti-bookmark mR-5"></i> Tarif AdÄ± *
                                            </label>
                                            <input asp-for="Title" class="form-control" required placeholder="Ã–rn: Tavuklu Pilav" />
                                            <span asp-validation-for="Title" class="text-danger fsz-sm"></span>
                                        </div>

                                        <div class="layer w-100 mB-15">
                                            <label asp-for="Ingredients" class="form-label fw-600">
                                                <i class="ti-shopping-cart mR-5"></i> Malzemeler *
                                            </label>
                                            <div class="mT-22"></div>
                                            <div id="ingredientsEditor"></div>
                                            <textarea asp-for="Ingredients" id="Ingredients" name="Ingredients" class="d-none" required></textarea>
                                            <span asp-validation-for="Ingredients" class="text-danger fsz-sm"></span>
                                        </div>

                                        <div class="layer w-100 mB-20">
                                            <label asp-for="Description" class="form-label fw-600">
                                                <i class="ti-file-text mR-5"></i> KÄ±sa AÃ§Ä±klama
                                            </label>
                                            <textarea asp-for="Description" class="form-control" rows="2" placeholder="Tarif hakkÄ±nda kÄ±sa bir aÃ§Ä±klama yazÄ±n"></textarea>
                                            <span asp-validation-for="Description" class="text-danger fsz-sm"></span>
                                        </div>

                                        <div class="layer w-100 mB-15">
                                            <label asp-for="Tips" class="form-label fw-600">
                                                <i class="ti-light-bulb mR-5"></i> PÃ¼f NoktalarÄ±
                                            </label>
                                            <textarea asp-for="Tips" class="form-control" rows="3"
                                                      placeholder="PÃ¼f noktalarÄ±"></textarea>
                                        </div>

                                    </div>
                                </div>

                                <!-- SaÄŸ Kolon -->
                                <div class="col-lg-6 col-md-6">
                                    <div class="layers">
                                        <div class="layer w-100 mB-15">
                                            <label asp-for="CategoryId" class="form-label fw-600">
                                                <i class="ti-folder mR-5"></i> Kategori
                                            </label>
                                            <select asp-for="CategoryId" class="form-control">
                                                <option value="">Kategori SeÃ§in</option>
                                                @foreach (var category in categories)
                                                {
                                                    @if (Model.CategoryId == category.Id)
                                                    {
                                                        <option value="@category.Id" selected>@category.Name</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@category.Id">@category.Name</option>
                                                    }
                                                }
                                            </select>
                                        </div>

                                        <div class="layer w-100 mB-15">
                                            <div class="d-flex justify-content-between align-items-center mB-10">
                                                <label class="form-label fw-600 mB-0">
                                                    <i class="ti-list mR-5"></i> YapÄ±lÄ±ÅŸ *
                                                </label>
                                                <button type="button" class="dynamic-list-add-btn" onclick="addStepItem()">
                                                    <i class="ti-plus"></i> AdÄ±m Ekle
                                                </button>
                                            </div>
                                            <div id="stepsList" class="dynamic-list"></div>
                                            <textarea asp-for="Steps" id="Steps" name="Steps" class="d-none" required></textarea>
                                            <span asp-validation-for="Steps" class="text-danger fsz-sm"></span>
                                        </div>

                                        <div class="layer w-100 mB-15">
                                            <label class="form-label fw-600 mB-8">
                                                <i class="ti-image mR-5"></i> Tarif GÃ¶rselleri
                                            </label>
                                            <small class="c-grey-600 d-block mB-10">Birden Ã§ok fotoÄŸraf ekleyebilir veya deÄŸiÅŸtirebilirsiniz. Birini ana fotoÄŸraf olarak seÃ§ebilirsiniz.</small>
                                            
                                            <!-- Mevcut gÃ¶rseller -->
                                            @if (Model.Images != null && Model.Images.Any())
                                            {
                                                <div class="mB-15">
                                                    <label class="fw-600 mB-5">Mevcut GÃ¶rseller:</label>
                                                    <div id="existingImagesList">
                                                        @foreach (var img in Model.Images.OrderByDescending(i => i.IsPrimary).ThenBy(i => i.DisplayOrder))
                                                        {
                                                            <div class="existing-image-item mB-10 p-10 bd bgc-grey-50" data-image-id="@img.Id">
                                                                <div class="image-container">
                                                                    <img src="@img.ImageUrl" alt="GÃ¶rsel" />
                                                                    @if (img.IsPrimary)
                                                                    {
                                                                        <span class="badge bg-primary image-badge">Ana FotoÄŸraf</span>
                                                                    }
                                                                </div>
                                                                <div class="image-content">
                                                                    <div class="fw-600 mB-5">GÃ¶rsel @(img.DisplayOrder + 1)</div>
                                                                    <div class="d-flex gap-10">
                                                                        <button type="button" class="btn btn-sm @(img.IsPrimary ? "btn-primary" : "btn-outline-primary")" onclick="setExistingPrimary(@img.Id)">
                                                                            <i class="ti-star"></i> @(img.IsPrimary ? "Ana FotoÄŸraf" : "Ana FotoÄŸraf Yap")
                                                                        </button>
                                                                        <button type="button" class="btn btn-sm btn-danger" onclick="removeExistingImage(@img.Id)">
                                                                            <i class="ti-close"></i> KaldÄ±r
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                            else if (!string.IsNullOrEmpty(Model.ImageUrl))
                                            {
                                                <div class="mB-15">
                                                    <label class="fw-600 mB-5">Mevcut GÃ¶rsel:</label>
                                                    <div class="existing-image-item mB-10 p-10 bd bgc-grey-50" data-image-url="@Model.ImageUrl">
                                                        <div class="image-container">
                                                            <img src="@Model.ImageUrl" alt="@Model.Title" />
                                                            <span class="badge bg-primary image-badge">Ana FotoÄŸraf</span>
                                                        </div>
                                                        <div class="image-content">
                                                            <div class="fw-600 mB-5">Mevcut GÃ¶rsel</div>
                                                            <button type="button" class="btn btn-sm btn-danger" onclick="removeExistingImageUrl()">
                                                                <i class="ti-close"></i> KaldÄ±r
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                            
                                            <!-- Yeni gÃ¶rsel ekleme -->
                                            <div class="mB-10">
                                                <input type="file" name="imageFiles" id="imageFiles" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" class="form-control" multiple />
                                            </div>
                                            
                                            <!-- Yeni eklenen gÃ¶rseller listesi -->
                                            <div id="newImagesList" class="mT-15">
                                                <!-- Yeni gÃ¶rseller buraya eklenecek -->
                                            </div>
                                            
                                            <!-- Hidden inputs -->
                                            <input type="hidden" id="imageUrlsJson" name="imageUrlsJson" />
                                            <input type="hidden" id="primaryImageIndex" name="primaryImageIndex" value="@(Model.Images?.FirstOrDefault(i => i.IsPrimary)?.DisplayOrder ?? 0)" />
                                            <input type="hidden" id="removedImageIds" name="removedImageIds" />
                                        </div>
                                        <div class="layer w-100 mB-15">
                                            <label asp-for="AlternativeIngredients" class="form-label fw-600">
                                                <i class="ti-exchange-vertical mR-5"></i> Alternatif Malzemeler
                                            </label>
                                            <textarea asp-for="AlternativeIngredients" class="form-control" rows="3"
                                                      placeholder="Alternatif malzemeler"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mT-20">
                                <div class="bd-top pT-15">
                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="ti-save mR-5"></i> GÃ¼ncelle
                                        </button>
                                        <a asp-controller="Author" asp-action="MyRecipes" class="btn btn-secondary">
                                            <i class="ti-close mR-5"></i> Ä°ptal
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Mevcut gÃ¶rselleri window'a set et (recipe-form.js iÃ§in)
        window.existingImagesData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Images ?? new List<FrontendMvc.Models.Recipes.RecipeImageViewModel>()));
    </script>
    <script src="~/js/recipe-form.js"></script>
}
