@model FrontendMvc.Models.Recipes.RecipeViewModel

@{
	ViewData["Title"] = "Tarif DÃ¼zenle";
	Layout = "~/Views/Shared/_Layout.cshtml";
	var categories = ViewBag.Categories as List<FrontendMvc.Models.Recipes.CategoryViewModel> ?? new();
}

@section Styles {
	<link rel="stylesheet" href="~/css/recipe-form.css" />
}

<div class="edit-recipe-container">
	<div class="row">
		<div class="col-12">
			<div class="bd bgc-white p-20 edit-recipe-container">
				<div class="layers">
					<div class="layer w-100 mB-15">
						<div class="peers fxw-nw ai-c">
							<div class="peer peer-greed">
								<h4 class="lh-1 mB-0">
									<i class="ti-pencil mR-10"></i> Tarif DÃ¼zenle
								</h4>
							</div>
						</div>
					</div>

					<div class="layer w-100 mB-15">
						<form asp-action="EditRecipe" asp-controller="Admin" asp-route-id="@Model.Id" method="post" enctype="multipart/form-data" id="editRecipeForm">
							<input type="hidden" asp-for="Id" />

							<!-- HÄ±zlÄ± Bilgi Ã‡ubuÄŸu -->
							<div class="layer w-100 mB-5">
								<div class="quick-info-bar">
									<div class="quick-info-item">
										<div class="form-check">
											<input asp-for="IsFeatured" class="form-check-input" type="checkbox" id="IsFeaturedTop" />
											<label class="form-check-label" for="IsFeaturedTop">
												<i class="ti-star mR-5"></i> Ã–ne Ã‡Ä±kan
											</label>
										</div>
									</div>
									<div class="quick-info-item">
										<label asp-for="PrepTimeMinutes" class="mB-0">
											<i class="ti-timer mR-5"></i> HazÄ±rlÄ±k (dk):
										</label>
										<input asp-for="PrepTimeMinutes" class="form-control form-control-sm d-inline-block" type="number" min="0" placeholder="0" />
									</div>
									<div class="quick-info-item">
										<label asp-for="CookingTimeMinutes" class="mB-0">
											<i class="ti-time mR-5"></i> PiÅŸirme (dk) *:
										</label>
										<input asp-for="CookingTimeMinutes" class="form-control form-control-sm d-inline-block" type="number" min="1" required placeholder="30" />
										<span asp-validation-for="CookingTimeMinutes" class="text-danger fsz-xs"></span>
									</div>
									<div class="quick-info-item">
										<label asp-for="Servings" class="mB-0">
											<i class="ti-user mR-5"></i> KaÃ§ KiÅŸilik:
										</label>
										<input asp-for="Servings" class="form-control form-control-sm d-inline-block" type="number" min="1" placeholder="4" style="width: 60px; min-width: 60px; max-width: 60px; text-align: center;" />
									</div>
									<div class="quick-info-item">
										<label asp-for="Difficulty" class="mB-0">
											<i class="ti-settings mR-5"></i> Zorluk:
										</label>
										<select asp-for="Difficulty" class="form-control form-control-sm d-inline-block">
											<option value="Kolay" selected="@(Model.Difficulty == "Kolay")">ðŸŸ¢ Kolay</option>
											<option value="Orta" selected="@(Model.Difficulty == "Orta")">ðŸŸ¡ Orta</option>
											<option value="Zor" selected="@(Model.Difficulty == "Zor")">ðŸ”´ Zor</option>
										</select>
									</div>
								</div>
							</div>
							<div class="row">
								<!-- Sol Kolon -->
								<div class="col-lg-6 col-md-6">
									<div class="layers">
										<div class="layer w-100 mB-15">
											<label asp-for="Title" class="form-label fw-600">
												<i class="ti-bookmark mR-5"></i> Tarif AdÄ± *
											</label>
											<input asp-for="Title" class="form-control" required placeholder="Ã–rn: Tavuklu Pilav" />
											<span asp-validation-for="Title" class="text-danger fsz-sm"></span>
										</div>

										<div class="layer w-100 mB-15">
											<label asp-for="Ingredients" class="form-label fw-600">
												<i class="ti-shopping-cart mR-5"></i> Malzemeler *
											</label>
											<div style="margin-top:22px;"></div>
											<div id="ingredientsEditor"></div>
											<textarea asp-for="Ingredients" id="Ingredients" name="Ingredients" class="d-none" required></textarea>
											<span asp-validation-for="Ingredients" class="text-danger fsz-sm"></span>
										</div>

										<div class="layer w-100 mB-20">
											<label asp-for="Description" class="form-label fw-600">
												<i class="ti-file-text mR-5"></i> KÄ±sa AÃ§Ä±klama
											</label>
											<textarea asp-for="Description" class="form-control" rows="2" placeholder="Tarif hakkÄ±nda kÄ±sa bir aÃ§Ä±klama yazÄ±n"></textarea>
											<span asp-validation-for="Description" class="text-danger fsz-sm"></span>
										</div>

										<div class="layer w-100 mB-15">
											<label asp-for="Tips" class="form-label fw-600">
												<i class="ti-light-bulb mR-5"></i> PÃ¼f NoktalarÄ±
											</label>
											<textarea asp-for="Tips" class="form-control" rows="3"
													  placeholder="PÃ¼f noktalarÄ±"></textarea>
										</div>

									</div>
								</div>

								<!-- SaÄŸ Kolon -->
								<div class="col-lg-6 col-md-6">
									<div class="layers">
										<div class="layer w-100 mB-15">
											<label asp-for="CategoryId" class="form-label fw-600">
												<i class="ti-folder mR-5"></i> Kategori
											</label>
											<select asp-for="CategoryId" class="form-control">
												<option value="">Kategori SeÃ§in</option>
												@foreach (var category in categories)
												{
													@if (Model.CategoryId == category.Id)
													{
														<option value="@category.Id" selected>@category.Name</option>
													}
													else
													{
														<option value="@category.Id">@category.Name</option>
													}
												}
											</select>
										</div>

										<div class="layer w-100 mB-15">
											<div class="d-flex justify-content-between align-items-center mB-10">
												<label class="form-label fw-600 mB-0">
													<i class="ti-list mR-5"></i> YapÄ±lÄ±ÅŸ *
												</label>
												<button type="button" class="dynamic-list-add-btn" onclick="addStepItem()">
													<i class="ti-plus"></i> AdÄ±m Ekle
												</button>
											</div>
											<div id="stepsList" class="dynamic-list"></div>
											<textarea asp-for="Steps" id="Steps" name="Steps" class="d-none" required></textarea>
											<span asp-validation-for="Steps" class="text-danger fsz-sm"></span>
										</div>

										<div class="layer w-100 mB-15">
											<label class="form-label fw-600 mB-8">
												<i class="ti-image mR-5"></i> Tarif GÃ¶rselleri
											</label>
											<small class="c-grey-600 d-block mB-10">Birden Ã§ok fotoÄŸraf ekleyebilir veya deÄŸiÅŸtirebilirsiniz. Birini ana fotoÄŸraf olarak seÃ§ebilirsiniz.</small>
											
											<!-- Mevcut gÃ¶rseller -->
											@if (Model.Images != null && Model.Images.Any())
											{
												<div class="mB-15">
													<label class="fw-600 mB-5">Mevcut GÃ¶rseller:</label>
													<div id="existingImagesList">
														@foreach (var img in Model.Images.OrderBy(i => i.DisplayOrder))
														{
															<div class="existing-image-item mB-10 p-10 bd bgc-grey-50" data-image-id="@img.Id" style="display: flex; align-items: center; gap: 15px; border-radius: 8px;">
																<div style="position: relative; width: 100px; height: 100px; flex-shrink: 0;">
																	<img src="@img.ImageUrl" alt="GÃ¶rsel" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;" />
																	@if (img.IsPrimary)
																	{
																		<span class="badge bg-primary" style="position: absolute; top: 5px; left: 5px;">Ana FotoÄŸraf</span>
																	}
																</div>
																<div style="flex: 1;">
																	<div class="fw-600 mB-5">GÃ¶rsel @(img.DisplayOrder + 1)</div>
																	<div class="d-flex gap-10">
																		<button type="button" class="btn btn-sm @(img.IsPrimary ? "btn-primary" : "btn-outline-primary")" onclick="setExistingPrimary(@img.Id)">
																			<i class="ti-star"></i> @(img.IsPrimary ? "Ana FotoÄŸraf" : "Ana FotoÄŸraf Yap")
																		</button>
																		<button type="button" class="btn btn-sm btn-danger" onclick="removeExistingImage(@img.Id)">
																			<i class="ti-close"></i> KaldÄ±r
																		</button>
																	</div>
																</div>
															</div>
														}
													</div>
												</div>
											}
											else if (!string.IsNullOrEmpty(Model.ImageUrl))
											{
												<div class="mB-15">
													<label class="fw-600 mB-5">Mevcut GÃ¶rsel:</label>
													<div class="existing-image-item mB-10 p-10 bd bgc-grey-50" data-image-url="@Model.ImageUrl" style="display: flex; align-items: center; gap: 15px; border-radius: 8px;">
														<div style="position: relative; width: 100px; height: 100px; flex-shrink: 0;">
															<img src="@Model.ImageUrl" alt="@Model.Title" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;" />
															<span class="badge bg-primary" style="position: absolute; top: 5px; left: 5px;">Ana FotoÄŸraf</span>
														</div>
														<div style="flex: 1;">
															<div class="fw-600 mB-5">Mevcut GÃ¶rsel</div>
															<button type="button" class="btn btn-sm btn-danger" onclick="removeExistingImageUrl()">
																<i class="ti-close"></i> KaldÄ±r
															</button>
														</div>
													</div>
												</div>
											}
											
											<!-- Yeni gÃ¶rsel ekleme -->
											<div class="mB-10">
												<input type="file" name="imageFiles" id="imageFiles" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" class="form-control" multiple />
												<small class="c-grey-600 d-block mT-5">JPG, PNG, GIF veya WebP formatÄ±nda, maksimum 5MB (birden Ã§ok seÃ§ebilirsiniz)</small>
											</div>
											
											<!-- URL ile ekleme -->
											<div class="mB-10">
												<div class="d-flex gap-10 ai-c" style="flex-wrap: wrap;">
													<input type="text" id="imageUrlInput" class="form-control" placeholder="https://example.com/image.jpg" style="flex: 1; min-width: 200px;" />
													<button type="button" id="addImageUrl" class="btn btn-sm btn-outline-primary">
														<i class="ti-plus"></i> URL Ekle
													</button>
												</div>
											</div>
											
											<!-- Yeni eklenen gÃ¶rseller listesi -->
											<div id="newImagesList" class="mT-15">
												<!-- Yeni gÃ¶rseller buraya eklenecek -->
											</div>
											
											<!-- Hidden inputs -->
											<input type="hidden" id="imageUrlsJson" name="imageUrlsJson" />
											<input type="hidden" id="primaryImageIndex" name="primaryImageIndex" value="@(Model.Images?.FirstOrDefault(i => i.IsPrimary)?.DisplayOrder ?? 0)" />
											<input type="hidden" id="removedImageIds" name="removedImageIds" />
										</div>
										<div class="layer w-100 mB-15">
											<label asp-for="AlternativeIngredients" class="form-label fw-600">
												<i class="ti-exchange-vertical mR-5"></i> Alternatif Malzemeler
											</label>
											<textarea asp-for="AlternativeIngredients" class="form-control" rows="3"
													  placeholder="Alternatif malzemeler"></textarea>
										</div>
									</div>
								</div>
							</div>

								<div class="row mT-20">
									<div class="bd-top pT-15">
										<div class="peers fxw-nw gap-10" style="justify-content: flex-end;">
											<div class="peer">
												<button type="submit" class="btn btn-primary" style="color: white;">
													<i class="ti-save mR-5"></i> GÃ¼ncelle
												</button>
											</div>
											<div class="peer">
												<a asp-controller="Admin" asp-action="Recipes" class="btn btn-secondary" style="color: white;">
													<i class="ti-close mR-5"></i> Ä°ptal
												</a>
											</div>
										</div>
									</div>
								</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>

	@section Scripts {
		<partial name="_ValidationScriptsPartial" />
		<script src="~/js/recipe-form.js"></script>
		<script>
			// Ã‡oklu fotoÄŸraf yÃ¶netimi (Edit iÃ§in)
			let existingImages = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Images ?? new List<FrontendMvc.Models.Recipes.RecipeImageViewModel>()));
			let newImages = [];
			let removedImageIds = [];
			let primaryImageIndex = @(Model.Images?.FirstOrDefault(i => i.IsPrimary)?.DisplayOrder ?? 0);

			const imageFilesInput = document.getElementById('imageFiles');
			const imageUrlInput = document.getElementById('imageUrlInput');
			const addImageUrlBtn = document.getElementById('addImageUrl');
			const newImagesList = document.getElementById('newImagesList');
			const imageUrlsJsonInput = document.getElementById('imageUrlsJson');
			const primaryImageIndexInput = document.getElementById('primaryImageIndex');
			const removedImageIdsInput = document.getElementById('removedImageIds');

			// Dosya seÃ§ildiÄŸinde
			if (imageFilesInput) {
				imageFilesInput.addEventListener('change', function(e) {
					const files = Array.from(e.target.files);
					files.forEach(file => {
						if (file.size > 5 * 1024 * 1024) {
							alert(`${file.name} dosyasÄ± 5MB'dan bÃ¼yÃ¼k!`);
							return;
						}
						const reader = new FileReader();
						reader.onload = function(e) {
							const imageData = {
								url: e.target.result,
								file: file,
								isFile: true,
								isPrimary: existingImages.length === 0 && newImages.length === 0
							};
							newImages.push(imageData);
							if (existingImages.length === 0 && newImages.length === 1) {
								primaryImageIndex = 0;
								primaryImageIndexInput.value = '0';
							}
							renderNewImagesList();
						};
						reader.readAsDataURL(file);
					});
				});
			}

			// URL ile ekleme
			if (addImageUrlBtn && imageUrlInput) {
				addImageUrlBtn.addEventListener('click', function() {
					const url = imageUrlInput.value.trim();
					if (!url) {
						alert('LÃ¼tfen geÃ§erli bir URL giriniz!');
						return;
					}
					const imageData = {
						url: url,
						isFile: false,
						isPrimary: existingImages.length === 0 && newImages.length === 0
					};
					newImages.push(imageData);
					if (existingImages.length === 0 && newImages.length === 1) {
						primaryImageIndex = 0;
						primaryImageIndexInput.value = '0';
					}
					imageUrlInput.value = '';
					renderNewImagesList();
				});
			}

			// Yeni gÃ¶rselleri render et
			function renderNewImagesList() {
				if (!newImagesList) return;
				
				newImagesList.innerHTML = '';
				
				if (newImages.length === 0) return;
				
				newImages.forEach((img, index) => {
					const imageItem = document.createElement('div');
					imageItem.className = 'image-item mB-10 p-10 bd bgc-grey-50';
					imageItem.style.cssText = 'display: flex; align-items: center; gap: 15px; border-radius: 8px;';
					
					const globalIndex = existingImages.length + index;
					imageItem.innerHTML = `
						<div style="position: relative; width: 100px; height: 100px; flex-shrink: 0;">
							<img src="${img.url}" alt="Yeni GÃ¶rsel ${index + 1}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;" />
							${img.isPrimary ? '<span class="badge bg-primary" style="position: absolute; top: 5px; left: 5px;">Ana FotoÄŸraf</span>' : ''}
						</div>
						<div style="flex: 1;">
							<div class="fw-600 mB-5">Yeni GÃ¶rsel ${index + 1}</div>
							<div class="fsz-sm text-muted mB-10">${img.isFile ? 'YÃ¼klenecek dosya' : 'URL'}</div>
							<div class="d-flex gap-10">
								<button type="button" class="btn btn-sm ${img.isPrimary ? 'btn-primary' : 'btn-outline-primary'}" onclick="setNewPrimaryImage(${index})">
									<i class="ti-star"></i> ${img.isPrimary ? 'Ana FotoÄŸraf' : 'Ana FotoÄŸraf Yap'}
								</button>
								<button type="button" class="btn btn-sm btn-danger" onclick="removeNewImage(${index})">
									<i class="ti-close"></i> KaldÄ±r
								</button>
							</div>
						</div>
					`;
					
					newImagesList.appendChild(imageItem);
				});
				
				updateHiddenInputs();
			}

			// Mevcut gÃ¶rseli ana fotoÄŸraf yap
			window.setExistingPrimary = function(imageId) {
				const image = existingImages.find(img => img.id === imageId);
				if (!image) return;
				
				// TÃ¼m mevcut gÃ¶rselleri gÃ¼ncelle
				existingImages.forEach(img => {
					img.isPrimary = img.id === imageId;
				});
				
				// Yeni gÃ¶rselleri gÃ¼ncelle
				newImages.forEach(img => {
					img.isPrimary = false;
				});
				
				primaryImageIndex = existingImages.findIndex(img => img.id === imageId);
				primaryImageIndexInput.value = primaryImageIndex.toString();
				
				// UI'Ä± gÃ¼ncelle
				document.querySelectorAll('.existing-image-item').forEach(item => {
					const btn = item.querySelector('button');
					if (btn) {
						const isPrimary = item.dataset.imageId == imageId;
						btn.className = `btn btn-sm ${isPrimary ? 'btn-primary' : 'btn-outline-primary'}`;
						btn.innerHTML = `<i class="ti-star"></i> ${isPrimary ? 'Ana FotoÄŸraf' : 'Ana FotoÄŸraf Yap'}`;
					}
				});
				
				renderNewImagesList();
			};

			// Mevcut gÃ¶rseli kaldÄ±r
			window.removeExistingImage = function(imageId) {
				if (confirm('Bu gÃ¶rseli kaldÄ±rmak istediÄŸinize emin misiniz?')) {
					removedImageIds.push(imageId);
					existingImages = existingImages.filter(img => img.id !== imageId);
					
					// Ana fotoÄŸraf gÃ¼ncelle
					if (existingImages.length > 0 && !existingImages.some(img => img.isPrimary)) {
						existingImages[0].isPrimary = true;
						primaryImageIndex = 0;
					}
					
					removedImageIdsInput.value = JSON.stringify(removedImageIds);
					
					// UI'dan kaldÄ±r
					const item = document.querySelector(`[data-image-id="${imageId}"]`);
					if (item) item.remove();
				}
			};

			// Mevcut URL gÃ¶rselini kaldÄ±r
			window.removeExistingImageUrl = function() {
				if (confirm('Bu gÃ¶rseli kaldÄ±rmak istediÄŸinize emin misiniz?')) {
					const item = document.querySelector('[data-image-url]');
					if (item) item.remove();
					// ImageUrl'i temizle (backend'de null olacak)
				}
			};

			// Yeni gÃ¶rseli ana fotoÄŸraf yap
			window.setNewPrimaryImage = function(index) {
				// TÃ¼m gÃ¶rselleri gÃ¼ncelle
				existingImages.forEach(img => img.isPrimary = false);
				newImages.forEach((img, i) => {
					img.isPrimary = i === index;
				});
				
				primaryImageIndex = existingImages.length + index;
				primaryImageIndexInput.value = primaryImageIndex.toString();
				
				renderNewImagesList();
			};

			// Yeni gÃ¶rseli kaldÄ±r
			window.removeNewImage = function(index) {
				if (confirm('Bu gÃ¶rseli kaldÄ±rmak istediÄŸinize emin misiniz?')) {
					newImages.splice(index, 1);
					if (newImages.length > 0 && !newImages.some(img => img.isPrimary)) {
						newImages[0].isPrimary = true;
						primaryImageIndex = existingImages.length;
					}
					renderNewImagesList();
				}
			};

			// Hidden input'larÄ± gÃ¼ncelle
			function updateHiddenInputs() {
				if (imageUrlsJsonInput) {
					const allUrls = [...existingImages.map(img => img.imageUrl), ...newImages.map(img => img.url)];
					imageUrlsJsonInput.value = JSON.stringify(allUrls);
				}
			}

			// Form submit edilmeden Ã¶nce
			const form = document.getElementById('editRecipeForm') || document.querySelector('form');
			if (form) {
				// Form action'Ä±nÄ± kontrol et ve doÄŸru action'Ä± set et
				const recipeId = @Model.Id;
				const correctAction = `/Admin/EditRecipe/${recipeId}`;
				if (!form.action || form.action.includes('/Admin/Edit') && !form.action.includes('EditRecipe')) {
					form.action = correctAction;
				}
				console.log('Form action set to:', form.action);
				
				const submitHandler = async function(e) {
					console.log('EditRecipe form submit event tetiklendi');
					console.log('Form action:', form.action);
					
					// Form validation kontrolÃ¼
					if (!form.checkValidity()) {
						console.error('Form validation hatasÄ± var');
						form.reportValidity();
						return;
					}
					
					// Ã–NEMLÄ°: Form submit edilmeden Ã¶nce Ingredients ve Steps textarea'larÄ±nÄ± gÃ¼ncelle
					// Quill editÃ¶rÃ¼nden iÃ§eriÄŸi al
					if (typeof ingredientsQuill !== 'undefined' && ingredientsQuill) {
						const ingredientsTextarea = document.getElementById('Ingredients');
						if (ingredientsTextarea) {
							const htmlData = ingredientsQuill.root.innerHTML;
							if (typeof convertHtmlToPlainText === 'function') {
								const plain = convertHtmlToPlainText(htmlData);
								ingredientsTextarea.value = plain;
								console.log('Ingredients gÃ¼ncellendi:', plain.substring(0, 50) + '...');
							} else {
								// Fallback: HTML'den text Ã§Ä±kar
								const tempDiv = document.createElement('div');
								tempDiv.innerHTML = htmlData;
								ingredientsTextarea.value = tempDiv.textContent || tempDiv.innerText || '';
								console.log('Ingredients gÃ¼ncellendi (fallback)');
							}
						} else {
							console.error('Ingredients textarea bulunamadÄ±!');
						}
					} else {
						console.warn('ingredientsQuill tanÄ±mlÄ± deÄŸil');
					}
					
					// Steps textarea'sÄ±nÄ± gÃ¼ncelle
					if (typeof updateStepsTextarea === 'function') {
						updateStepsTextarea();
						const stepsTextarea = document.getElementById('Steps');
						if (stepsTextarea) {
							console.log('Steps gÃ¼ncellendi:', stepsTextarea.value.substring(0, 50) + '...');
						}
					} else {
						// Fallback: Manuel olarak gÃ¼ncelle
						const stepsList = document.getElementById('stepsList');
						const stepsTextarea = document.getElementById('Steps');
						if (stepsList && stepsTextarea) {
							const items = stepsList.querySelectorAll('.item-input');
							const values = Array.from(items).map(input => input.value.trim()).filter(v => v);
							stepsTextarea.value = values.join('\n');
							console.log('Steps gÃ¼ncellendi (fallback):', stepsTextarea.value.substring(0, 50) + '...');
						} else {
							console.error('Steps textarea veya list bulunamadÄ±!');
						}
					}
					
					// Hidden input'larÄ± gÃ¼ncelle
					updateHiddenInputs();
					
					// Yeni gÃ¶rselleri S3'e yÃ¼kle (eÄŸer varsa)
					const filesToUpload = newImages.filter(img => img.isFile && img.file);
					
					if (filesToUpload.length > 0) {
						console.log('Yeni gÃ¶rseller S3\'e yÃ¼kleniyor...', filesToUpload.length, 'dosya');
						e.preventDefault(); // Ã–nce S3'e yÃ¼kleyelim
						
						try {
							const uploadPromises = filesToUpload.map(async (imgData) => {
								try {
									const formData = new FormData();
									formData.append('file', imgData.file);
									
									// Token'Ä± al
									let token = '';
									if (typeof getAuthToken === 'function') {
										token = getAuthToken();
									} else if (typeof localStorage !== 'undefined') {
										token = localStorage.getItem('authToken') || '';
									}
									
									const headers = {};
									if (token) {
										headers['Authorization'] = `Bearer ${token}`;
									}
									
									// Backend API URL'ini al
									const apiBaseUrl = window.API_BASE_URL || 'https://localhost:7016';
									const uploadUrl = `${apiBaseUrl}/api/upload/image`;
									
									const response = await fetch(uploadUrl, {
										method: 'POST',
										headers: headers,
										body: formData
									});
									
									if (response.ok) {
										const result = await response.json();
										if (result.url) {
											// Base64 URL'yi S3 URL'i ile deÄŸiÅŸtir
											const oldIndex = newImages.findIndex(img => img === imgData);
											if (oldIndex !== -1) {
												newImages[oldIndex].url = result.url;
												newImages[oldIndex].isFile = false; // ArtÄ±k URL
											}
											return result.url;
										}
									} else {
										const error = await response.text();
										console.error('S3 upload failed:', error);
										throw new Error(`Upload failed: ${error}`);
									}
								} catch (error) {
									console.error('Error uploading to S3:', error);
									throw error;
								}
							});
							
							await Promise.all(uploadPromises);
							console.log('TÃ¼m gÃ¶rseller S3\'e yÃ¼klendi');
							
							// Hidden input'larÄ± tekrar gÃ¼ncelle (S3 URL'leri ile)
							updateHiddenInputs();
							
							// imageFiles input'unu temizle
							if (imageFilesInput) {
								imageFilesInput.value = '';
							}
							
							// Form submit et
							console.log('Form submit ediliyor (gÃ¶rseller yÃ¼klendikten sonra)...');
							setTimeout(() => {
								form.removeEventListener('submit', submitHandler);
								// Form action'Ä±nÄ± tekrar kontrol et
								const recipeId = @Model.Id;
								const correctAction = `/Admin/EditRecipe/${recipeId}`;
								if (!form.action || (form.action.includes('/Admin/Edit') && !form.action.includes('EditRecipe'))) {
									form.action = correctAction;
								}
								console.log('Final form action:', form.action);
								form.submit();
							}, 500);
						} catch (error) {
							alert('GÃ¶rseller yÃ¼klenirken hata oluÅŸtu: ' + error.message);
							console.error('Upload error:', error);
						}
					} else {
						// YÃ¼klenecek dosya yok, direkt submit et
						console.log('Yeni gÃ¶rsel yok, form direkt submit ediliyor...');
						// Form action'Ä±nÄ± kontrol et
						const recipeId = @Model.Id;
						const correctAction = `/Admin/EditRecipe/${recipeId}`;
						if (!form.action || (form.action.includes('/Admin/Edit') && !form.action.includes('EditRecipe'))) {
							form.action = correctAction;
						}
						console.log('Final form action:', form.action);
					}
				};
				form.addEventListener('submit', submitHandler);
			}
		</script>
	}